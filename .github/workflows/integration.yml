name: Full Integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  # =====================================
  # FULL BUILD MATRIX
  # =====================================
  full-build:
    name: Full Build - All Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - auth-service
          - user-profiling-service
          - strategy-service
      fail-fast: false
    defaults:
      run:
        working-directory: backend/services/${{ matrix.service }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Make mvnw executable
        run: chmod +x mvnw

      - name: Build ${{ matrix.service }}
        run: ./mvnw clean package -DskipTests -q

      - name: Test ${{ matrix.service }}
        run: ./mvnw test -q
        continue-on-error: true

  # =====================================
  # FRONTEND FULL BUILD
  # =====================================
  frontend-full:
    name: Frontend Full Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install, Lint, Build
        run: |
          npm ci
          npm run lint || true
          npm run build

  # =====================================
  # DOCKER COMPOSE VALIDATION
  # =====================================
  docker-compose-check:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: docker compose config --quiet

      - name: Check all required files exist
        run: |
          echo "ðŸ“ Checking required files..."
          
          # Check docker-compose
          [ -f "docker-compose.yml" ] && echo "âœ… docker-compose.yml" || echo "âŒ docker-compose.yml"
          
          # Check services have required files
          for service in auth-service user-profiling-service strategy-service; do
            dir="backend/services/$service"
            [ -f "$dir/pom.xml" ] && echo "âœ… $service/pom.xml" || echo "âš ï¸ $service/pom.xml missing"
            [ -f "$dir/mvnw" ] && echo "âœ… $service/mvnw" || echo "âš ï¸ $service/mvnw missing"
          done
          
          # Check frontend
          [ -f "frontend/package.json" ] && echo "âœ… frontend/package.json" || echo "âŒ frontend/package.json"

  # =====================================
  # SECURITY SCAN
  # =====================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

  # =====================================
  # CODE QUALITY REPORT
  # =====================================
  code-quality-report:
    name: Code Quality Report
    runs-on: ubuntu-latest
    needs: [full-build, frontend-full]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate report
        run: |
          echo "# ðŸ“Š Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Project Structure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "| Auth Service | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "| User Profiling | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "| Strategy Service | âœ… Built |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total TypeScript files:** $(find frontend/src -name '*.ts' -o -name '*.tsx' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Java files:** $(find backend -name '*.java' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total YAML configs:** $(find . -name '*.yml' -o -name '*.yaml' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY

  # =====================================
  # RELEASE CHECK
  # =====================================
  release-readiness:
    name: Release Readiness Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [full-build, frontend-full, docker-compose-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check release readiness
        run: |
          echo "ðŸš€ Release Readiness Check"
          echo ""
          echo "âœ… All backend services built successfully"
          echo "âœ… Frontend built successfully"
          echo "âœ… Docker Compose validated"
          echo ""
          echo "Ready for deployment! ðŸŽ‰"
